---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, render } from "astro:content";

const entries = await getCollection("case-studies");
const studies = await Promise.all(
	entries.map(async (entry) => {
		const { Content } = await render(entry);
		const rawSlug = entry.data.slug ?? entry.slug;
		const trimmed = rawSlug.replace(/^\/+|\/+$/g, "");
		const slug =
			trimmed === "index"
				? ""
				: trimmed.endsWith("/index")
					? trimmed.slice(0, -"/index".length)
					: trimmed;
		const modalId = `case-study-${(slug || entry.slug).replace(/\//g, "-")}`;

		return {
			title: entry.data.title,
			slug: slug || entry.slug,
			modalId,
			Content,
		};
	})
);
const orderedStudies = studies.map((study, index) => ({ ...study, index }));
---

<BaseLayout title="Medical Case Studies">
	<section class="grid gap-10 lg:grid-cols-[2fr_1fr] lg:items-start">
		<div class="space-y-6 text-base leading-7">
			<header class="space-y-3">
				<h1 class="text-4xl font-light tracking-tight text-[color:var(--paragon-black)]">
					Medical Case Studies
				</h1>
			</header>

			<div class="space-y-4 text-neutral-700">
				<p>
					Paragon has conducted medical case studies related to disease and other conditions
					affecting its athletes, case study subjects, and medical clients since 1989.
				</p>
				<p>
					Use this space for the WordPress copy that introduces the case study program and
					frames the list on the right.
				</p>
			</div>
		</div>

		<aside class="rounded-lg border border-neutral-200 bg-white p-6 shadow-sm">
			<h2 class="text-sm font-semibold uppercase tracking-wide text-neutral-500">
				Case Studies
			</h2>
			<ul class="mt-4 space-y-2 text-sm text-neutral-800">
				{studies.length ? (
					studies.map((study) => (
						<li>
							<button
								type="button"
								class="text-left font-semibold hover:text-[color:var(--paragon-green)]"
								data-dialog={study.modalId}
							>
								{study.title}
							</button>
						</li>
					))
				) : (
					<li class="text-neutral-500">Add case studies in Pages CMS.</li>
				)}
			</ul>
		</aside>
	</section>

	{orderedStudies.map((study) => (
		<dialog
			id={study.modalId}
			class="w-[min(92vw,960px)] overflow-hidden rounded-xl border-0 p-0 shadow-2xl"
			data-index={study.index}
		>
			<div class="flex max-h-[90vh] flex-col rounded-xl bg-white">
				<header class="relative rounded-t-xl bg-[color:var(--paragon-green)] px-8 py-6 text-white">
					<p class="text-xs uppercase tracking-wide text-white/80">Medical Case Study</p>
					<h2 class="mt-2 text-4xl font-light">{study.title}</h2>
					<button
						type="button"
						class="absolute right-4 top-4 text-2xl text-white/80 hover:text-white"
						data-close
					>
						Ã—
					</button>
				</header>
				<div class="modal-body space-y-6 overflow-y-auto px-8 py-6 text-base leading-7 text-neutral-800">
					<study.Content />
				</div>
			</div>
			<button
				type="button"
				class="absolute -left-10 top-1/2 -translate-y-1/2 p-2 text-3xl text-white/80 hover:text-white"
				data-nav="prev"
				aria-label="Previous case study"
			>
				&#8249;
			</button>
			<button
				type="button"
				class="absolute -right-10 top-1/2 -translate-y-1/2 p-2 text-3xl text-white/80 hover:text-white"
				data-nav="next"
				aria-label="Next case study"
			>
				&#8250;
			</button>
		</dialog>
	))}

	<style>
		dialog {
			inset: 0;
			margin: auto;
			overflow: visible;
		}

		:global(.modal-body h2) {
			font-size: 1.5rem;
			line-height: 2rem;
		}

		dialog::backdrop {
			background: rgba(25, 25, 25, 0.6);
		}
	</style>

	<script>
		const dialogs = Array.from(document.querySelectorAll("dialog"));
		let activeIndex = -1;
		let activeDialog = null;
		const openDialog = (index) => {
			const normalizedIndex = (index + dialogs.length) % dialogs.length;
			const target = dialogs[normalizedIndex];
			if (!target) return;
			activeDialog = target;
			dialogs.forEach((dialog) => dialog.close());
			target.showModal();
			activeIndex = normalizedIndex;
		};

		document.querySelectorAll("[data-dialog]").forEach((button) => {
			const dialogId = button.getAttribute("data-dialog");
			const dialog = dialogId ? document.getElementById(dialogId) : null;
			if (!dialog) return;
			button.addEventListener("click", () => {
				const index = Number(dialog.dataset.index ?? 0);
				openDialog(index);
			});
		});

		document.querySelectorAll("[data-close]").forEach((button) => {
			const dialog = button.closest("dialog");
			if (!dialog) return;
			button.addEventListener("click", () => dialog.close());
		});

		document.querySelectorAll("[data-nav]").forEach((button) => {
			button.addEventListener("click", () => {
				if (activeIndex === -1) return;
				const direction = button.getAttribute("data-nav");
				const nextIndex = direction === "prev" ? activeIndex - 1 : activeIndex + 1;
				openDialog(nextIndex);
			});
		});

		dialogs.forEach((dialog) => {
			dialog.addEventListener("click", (event) => {
				if (event.target === dialog) {
					dialog.close();
				}
			});
			dialog.addEventListener("close", () => {
				if (dialog === activeDialog) {
					activeIndex = -1;
					activeDialog = null;
				}
			});
		});

		window.addEventListener("keydown", (event) => {
			if (activeIndex === -1) return;
			if (event.key === "ArrowLeft") {
				event.preventDefault();
				openDialog(activeIndex - 1);
			}
			if (event.key === "ArrowRight") {
				event.preventDefault();
				openDialog(activeIndex + 1);
			}
		});
	</script>
</BaseLayout>
