---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection, render } from "astro:content";

export async function getStaticPaths() {
	const pages = await getCollection("pages");

	return pages.map((page) => {
		const rawSlug = page.data.slug ?? page.slug;
		const trimmed = rawSlug.replace(/^\/+|\/+$/g, "");
		const slug =
			trimmed === "index"
				? ""
				: trimmed.endsWith("/index")
					? trimmed.slice(0, -"/index".length)
					: trimmed;
		return {
			params: { slug: slug === "" ? undefined : slug },
		};
	});
}

const requestedRawSlug = Astro.params.slug ?? "";
const requestedTrimmed = requestedRawSlug.replace(/^\/+|\/+$/g, "");
const requestedSlug =
	requestedTrimmed === "index"
		? ""
		: requestedTrimmed.endsWith("/index")
			? requestedTrimmed.slice(0, -"/index".length)
			: requestedTrimmed;
const pages = await getCollection("pages");
const entry = pages.find(
	(page) => {
		const entryRawSlug = page.data.slug ?? page.slug;
		const entryTrimmed = entryRawSlug.replace(/^\/+|\/+$/g, "");
		const entrySlug =
			entryTrimmed === "index"
				? ""
				: entryTrimmed.endsWith("/index")
					? entryTrimmed.slice(0, -"/index".length)
					: entryTrimmed;
		return entrySlug === requestedSlug;
	}
);

if (!entry) {
	throw new Error(`Page entry not found: ${requestedSlug || "index"}`);
}

const { Content, headings } = await render(entry);
const hero = entry.data.hero;
const tocHeadings = headings.filter((heading) => heading.depth === 2);
const showToc = entry.data.variant === "toc" && tocHeadings.length > 0;
const showBullets = entry.data.variant === "bullets" && entry.data.bullets?.length;
---

<BaseLayout title={entry.data.title}>
	<div class="space-y-12">
{hero?.layout === "full" && hero.src && (
			<img
				src={hero.src}
				alt={hero.alt ?? ""}
				class="w-full rounded-lg border border-neutral-200"
				loading="lazy"
			/>
		)}

		<section class="grid gap-8 md:grid-cols-[2fr_1fr] md:items-start">
			<div class="space-y-6">
				<header class="space-y-3">
					<h1 class="text-3xl font-semibold">{entry.data.title}</h1>
					{entry.data.description && (
						<p class="text-lg text-neutral-600">{entry.data.description}</p>
					)}
				</header>

				{showBullets && (
					<div class="rounded-lg border border-neutral-200 bg-neutral-100 px-5 py-4">
						<ul class="list-disc space-y-2 pl-5 text-base">
							{entry.data.bullets?.map((item) => <li>{item}</li>)}
						</ul>
					</div>
				)}

				{showToc && (
					<nav aria-label="Table of contents" class="rounded-lg border border-neutral-200 px-5 py-4">
						<p class="text-sm font-semibold uppercase tracking-wide text-neutral-500">
							On this page
						</p>
						<ul class="mt-3 space-y-2 text-sm text-neutral-700">
							{tocHeadings.map((heading) => (
								<li>
									<a href={`#${heading.slug}`} class="hover:text-[color:var(--paragon-green)]">
										{heading.text}
									</a>
								</li>
							))}
						</ul>
					</nav>
				)}
			</div>

{hero?.layout === "thumbnail" && hero.src && (
				<div class="w-full">
					<img
						src={hero.src}
						alt={hero.alt ?? ""}
						class="w-full rounded-lg border border-neutral-200"
						loading="lazy"
					/>
				</div>
			)}
		</section>

		<article class="space-y-6 text-base leading-7">
			<Content />
		</article>

		{entry.data.sources?.length && (
			<section class="space-y-2 border-t border-neutral-200 pt-6 text-sm text-neutral-500">
				<p class="font-semibold uppercase tracking-wide text-neutral-400">Sources</p>
				<ul class="space-y-1">
					{entry.data.sources.map((source) => (
						<li>
							{source.url ? (
								<a href={source.url} class="hover:text-[color:var(--paragon-green)]">
									{source.label}
								</a>
							) : (
								<span>{source.label}</span>
							)}
						</li>
					))}
				</ul>
			</section>
		)}
	</div>
</BaseLayout>
